<script>
    // =========================================
    // CONFIGURAÇÃO E DADOS
    // =========================================
    let transactions = [];
    let categories = [];
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let currency = 'BRL';
    let initialBalance = 0;
    let currentSection = 'dashboard';
    let editingCategoryId = null;

    // Categorias padrão
    const defaultCategories = [
        // Ganhos
        { id: 1, name: 'Salário', type: 'income', color: '#10b981', icon: 'fas fa-money-bill-wave' },
        { id: 2, name: 'Freelance', type: 'income', color: '#3b82f6', icon: 'fas fa-laptop-code' },
        { id: 3, name: 'Investimentos', type: 'income', color: '#8b5cf6', icon: 'fas fa-chart-line' },
        { id: 4, name: 'Presente', type: 'income', color: '#f59e0b', icon: 'fas fa-gift' },
        { id: 5, name: 'Outros Ganhos', type: 'income', color: '#6366f1', icon: 'fas fa-coins' },
       
        // Gastos
        { id: 6, name: 'Alimentação', type: 'expense', color: '#ef4444', icon: 'fas fa-utensils' },
        { id: 7, name: 'Transporte', type: 'expense', color: '#f97316', icon: 'fas fa-car' },
        { id: 8, name: 'Moradia', type: 'expense', color: '#14b8a6', icon: 'fas fa-home' },
        { id: 9, name: 'Lazer', type: 'expense', color: '#8b5cf6', icon: 'fas fa-film' },
        { id: 10, name: 'Saúde', type: 'expense', color: '#ec4899', icon: 'fas fa-heart' },
        { id: 11, name: 'Educação', type: 'expense', color: '#06b6d4', icon: 'fas fa-graduation-cap' },
        { id: 12, name: 'Compras', type: 'expense', color: '#f43f5e', icon: 'fas fa-shopping-cart' },
        { id: 13, name: 'Outros Gastos', type: 'expense', color: '#64748b', icon: 'fas fa-question-circle' }
    ];

    // =========================================
    // FUNÇÕES DE FORMATAÇÃO DE VALOR
    // =========================================
    
    // Formata valor para o formato brasileiro
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: currency
        }).format(value);
    }

    // Formata número para string formatada (1.234,56)
    function formatNumberToCurrency(value) {
        if (value === null || value === undefined || value === '') return '0,00';
        
        let numValue = typeof value === 'number' ? value : parseFloat(value);
        if (isNaN(numValue)) return '0,00';
        
        return numValue.toFixed(2)
            .replace('.', ',')
            .replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Converte string formatada para número
    function parseCurrencyToNumber(currencyString) {
        if (!currencyString) return 0;
        
        let cleaned = currencyString.replace(/[^\d,.-]/g, '');
        
        if (cleaned.includes(',')) {
            cleaned = cleaned.replace(/\./g, '').replace(',', '.');
        }
        
        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed;
    }

    // Formata input enquanto digita
    function formatCurrencyInput(event) {
        let input = event.target;
        let value = input.value.replace(/\D/g, '');
        
        if (value.length === 0) {
            input.value = '';
            return;
        }
        
        let numberValue = parseInt(value) / 100;
        input.value = formatNumberToCurrency(numberValue);
    }

    // Formata valor ao sair do campo
    function formatCurrencyOnBlur(event) {
        let input = event.target;
        let value = input.value;
        
        if (value === '') {
            input.value = '0,00';
            return;
        }
        
        let numberValue = parseCurrencyToNumber(value);
        input.value = formatNumberToCurrency(numberValue);
    }

    // =========================================
    // INICIALIZAÇÃO
    // =========================================
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        initializeApp();
        setupEventListeners();
        updateUI();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
    });

    function loadData() {
        // Carregar transações
        const savedTransactions = localStorage.getItem('minhas-financas-transactions');
        if (savedTransactions) {
            try {
                transactions = JSON.parse(savedTransactions);
            } catch (e) {
                console.error('Erro ao carregar transações:', e);
                transactions = [];
            }
        }

        // Carregar categorias
        const savedCategories = localStorage.getItem('minhas-financas-categories');
        if (savedCategories) {
            try {
                categories = JSON.parse(savedCategories);
            } catch (e) {
                console.error('Erro ao carregar categorias:', e);
                categories = defaultCategories;
            }
        } else {
            categories = defaultCategories;
            saveCategories();
        }

        // Carregar saldo inicial
        const savedInitialBalance = localStorage.getItem('minhas-financas-initial-balance');
        if (savedInitialBalance) {
            try {
                initialBalance = parseFloat(savedInitialBalance) || 0;
            } catch (e) {
                console.error('Erro ao carregar saldo inicial:', e);
                initialBalance = 0;
            }
        }
    }

    function saveData() {
        localStorage.setItem('minhas-financas-transactions', JSON.stringify(transactions));
        localStorage.setItem('minhas-financas-categories', JSON.stringify(categories));
        localStorage.setItem('minhas-financas-initial-balance', initialBalance.toString());
    }

    function saveCategories() {
        localStorage.setItem('minhas-financas-categories', JSON.stringify(categories));
    }

    function initializeApp() {
        // Configurar data atual no formulário
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-date').valueAsDate = new Date();
       
        // Preencher campo de saldo inicial
        document.getElementById('initial-balance-input').value = formatNumberToCurrency(initialBalance);
        document.getElementById('initial-balance-input-2').value = formatNumberToCurrency(initialBalance);
        document.getElementById('current-initial-balance').textContent = formatCurrency(initialBalance);
        document.getElementById('current-initial-balance-2').textContent = formatCurrency(initialBalance);
       
        // Inicializar selects de categoria
        updateCategorySelects();
       
        // Configurar controles de data
        updateDateDisplay();
        
        // Configurar ano atual nos filtros
        document.getElementById('year-selector-input').value = currentYear;
        document.getElementById('all-filter-year').value = currentYear;
        document.getElementById('report-year').value = currentYear;
        
        // Atualizar relatórios
        updateReports();
    }

    function setupEventListeners() {
        // Menu hambúrguer
        document.getElementById('menu-toggle').addEventListener('click', toggleMenu);
        document.getElementById('close-menu').addEventListener('click', toggleMenu);
        document.getElementById('menu-overlay').addEventListener('click', toggleMenu);
        
        // Itens do menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.getAttribute('data-section');
                if (section) {
                    switchSection(section);
                    toggleMenu();
                }
            });
        });

        // Formulário de transação
        document.getElementById('transaction-form').addEventListener('submit', addTransaction);
       
        // Formatação automática do campo de valor
        const amountInput = document.getElementById('amount');
        amountInput.addEventListener('input', formatCurrencyInput);
        amountInput.addEventListener('blur', formatCurrencyOnBlur);
        
        // Formatação do campo de saldo inicial
        const initialBalanceInput = document.getElementById('initial-balance-input');
        initialBalanceInput.addEventListener('input', formatCurrencyInput);
        initialBalanceInput.addEventListener('blur', formatCurrencyOnBlur);
        
        const initialBalanceInput2 = document.getElementById('initial-balance-input-2');
        initialBalanceInput2.addEventListener('input', formatCurrencyInput);
        initialBalanceInput2.addEventListener('blur', formatCurrencyOnBlur);
        
        // Atualizar saldo inicial
        document.getElementById('update-initial-balance-btn').addEventListener('click', updateInitialBalance);
        document.getElementById('update-initial-balance-btn-2').addEventListener('click', updateInitialBalance);
        
        // Seletor de tipo
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateCategorySelect(this.getAttribute('data-type'));
            });
        });

        // Controles de data (CALENDÁRIO INFINITO)
        document.getElementById('prev-year').addEventListener('click', () => changeYear(-1));
        document.getElementById('next-year').addEventListener('click', () => changeYear(1));
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
        document.getElementById('today-btn').addEventListener('click', goToToday);

        // Filtros de transações recentes
        document.getElementById('recent-filter-type').addEventListener('change', updateRecentTransactions);
        document.getElementById('recent-filter-category').addEventListener('change', updateRecentTransactions);
        document.getElementById('recent-filter-period').addEventListener('change', updateRecentTransactions);
        
        // Filtros de todas as transações (CALENDÁRIO INFINITO)
        document.getElementById('all-filter-type').addEventListener('change', updateAllTransactions);
        document.getElementById('all-filter-category').addEventListener('change', updateAllTransactions);
        document.getElementById('all-filter-year').addEventListener('input', updateAllTransactions);
        document.getElementById('all-filter-month').addEventListener('change', updateAllTransactions);
        
        // Histórico (CALENDÁRIO INFINITO)
        document.getElementById('load-year-history').addEventListener('click', function() {
            const year = parseInt(document.getElementById('year-selector-input').value);
            if (year && year >= 2000 && year <= 2100) {
                updateYearHistory(year);
            } else {
                showNotification('Por favor, digite um ano válido (2000-2100)', 'error');
            }
        });
        
        // Relatórios (CALENDÁRIO INFINITO)
        document.getElementById('generate-report').addEventListener('click', generateReport);
        
        // Configurações
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        
        // Categorias
        document.getElementById('add-category-btn').addEventListener('click', showCategoryForm);
        document.getElementById('cancel-category-btn').addEventListener('click', hideCategoryForm);
        document.getElementById('category-form').addEventListener('submit', saveCategory);
        
        // Upload de imagem para categorias
        document.getElementById('category-image-upload').addEventListener('change', handleCategoryImageUpload);
        document.getElementById('remove-category-image').addEventListener('click', removeCategoryImage);
    }

    // =========================================
    // MENU HAMBÚRGUER
    // =========================================
    function toggleMenu() {
        const menuContainer = document.getElementById('menu-container');
        const menuOverlay = document.getElementById('menu-overlay');
        
        menuContainer.classList.toggle('active');
        menuOverlay.classList.toggle('active');
    }

    function switchSection(sectionId) {
        // Esconder todas as seções
        document.querySelectorAll('.site-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Mostrar a seção selecionada
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            
            // Atualizar menu ativo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Atualizar a seção atual
            currentSection = sectionId;
            
            // Atualizar o conteúdo da seção se necessário
            if (sectionId === 'transactions') {
                updateAllTransactions();
            } else if (sectionId === 'reports') {
                updateReports();
            } else if (sectionId === 'categories') {
                updateCategoriesList();
            } else if (sectionId === 'history') {
                const currentYear = new Date().getFullYear();
                document.getElementById('year-selector-input').value = currentYear;
                updateYearHistory(currentYear);
            }
        }
    }

    // =========================================
    // DATA E HORA ATUAL
    // =========================================
    function updateCurrentTime() {
        const now = new Date();
       
        const dateOptions = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            timeZone: 'America/Sao_Paulo'
        };
        const dateFormatter = new Intl.DateTimeFormat('pt-BR', dateOptions);
        const dateString = dateFormatter.format(now);
       
        const timeOptions = {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZone: 'America/Sao_Paulo'
        };
        const timeFormatter = new Intl.DateTimeFormat('pt-BR', timeOptions);
        const timeString = timeFormatter.format(now);
       
        document.getElementById('current-date-display').textContent =
            dateString.charAt(0).toUpperCase() + dateString.slice(1);
        document.getElementById('current-time-display').textContent = timeString;
    }

    // =========================================
    // FUNÇÕES PRINCIPAIS
    // =========================================
    function updateUI() {
        updateDashboard();
        updateRecentTransactions();
        updateYearHistory(currentYear);
        updateTotalBalanceDisplay();
        updateAllTransactions();
    }

    // =========================================
    // SALDO INICIAL - FUNÇÃO MODIFICADA
    // =========================================
    function updateInitialBalance() {
        let input;
        if (currentSection === 'balance') {
            input = document.getElementById('initial-balance-input-2');
        } else {
            input = document.getElementById('initial-balance-input');
        }
        
        const value = parseCurrencyToNumber(input.value);
        
        if (isNaN(value) || value < 0) {
            showNotification('Por favor, digite um valor válido!', 'error');
            return;
        }
        
        initialBalance = value;
        saveData();
        updateTotalBalanceDisplay();
        document.getElementById('current-initial-balance').textContent = formatCurrency(initialBalance);
        document.getElementById('current-initial-balance-2').textContent = formatCurrency(initialBalance);
        showNotification('Saldo inicial atualizado com sucesso!');
    }

    // =========================================
    // SALDO TOTAL - FUNÇÃO MODIFICADA PARA ABATER GASTOS
    // =========================================
    function updateTotalBalanceDisplay() {
        // Calcular totais de TODAS as transações (não apenas do mês)
        let totalIncomeAll = 0;
        let totalExpenseAll = 0;
        
        transactions.forEach(transaction => {
            if (transaction.type === 'income') {
                totalIncomeAll += transaction.amount;
            } else {
                totalExpenseAll += transaction.amount;
            }
        });
        
        // Calcular saldo total: saldo inicial + todos os ganhos - todos os gastos
        const totalBalance = initialBalance + totalIncomeAll - totalExpenseAll;
        
        // Atualizar display no header
        const balanceElement = document.getElementById('total-balance-display');
        const headerBalance = document.getElementById('header-balance');
        
        balanceElement.textContent = formatCurrency(totalBalance);
        
        // Atualizar cores do header baseado no saldo
        if (totalBalance > 0) {
            headerBalance.className = 'header-balance positive';
        } else if (totalBalance < 0) {
            headerBalance.className = 'header-balance negative';
        } else {
            headerBalance.className = 'header-balance';
        }
    }

    // =========================================
    // TRANSAÇÕES - FUNÇÃO MODIFICADA PARA ATUALIZAR SALDO TOTAL
    // =========================================
    function addTransaction(e) {
        e.preventDefault();
       
        const type = document.querySelector('.type-btn.active').getAttribute('data-type');
        const description = document.getElementById('description').value.trim();
        const amount = parseCurrencyToNumber(document.getElementById('amount').value);
        const categoryId = parseInt(document.getElementById('category').value);
        const dateInput = document.getElementById('transaction-date').value;
       
        if (!description || amount <= 0 || !categoryId) {
            showNotification('Por favor, preencha todos os campos corretamente!', 'error');
            return;
        }
       
        const transaction = {
            id: Date.now() + Math.floor(Math.random() * 1000),
            type: type,
            description: description,
            amount: amount,
            categoryId: categoryId,
            date: dateInput || new Date().toISOString().split('T')[0],
            createdAt: new Date().toISOString()
        };
       
        transactions.push(transaction);
        saveData();
        
        // ATUALIZAR O SALDO TOTAL IMEDIATAMENTE
        updateTotalBalanceDisplay();
        updateUI(); // Atualiza o resto da interface
        
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-date').valueAsDate = new Date();
        document.getElementById('amount').value = '';
       
        showNotification('Transação adicionada com sucesso!');
    }

    function editTransaction(id) {
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) {
            console.error('Transação não encontrada:', id);
            return;
        }
        
        const newDescription = prompt('Nova descrição:', transaction.description);
        if (newDescription === null || newDescription.trim() === '') return;
        
        const currentValue = formatNumberToCurrency(transaction.amount);
        const newAmount = prompt('Novo valor (R$):', currentValue);
        if (newAmount === null) return;
        
        const parsedAmount = parseCurrencyToNumber(newAmount);
        if (isNaN(parsedAmount) || parsedAmount <= 0) {
            showNotification('Valor inválido!', 'error');
            return;
        }
        
        transaction.description = newDescription.trim();
        transaction.amount = parsedAmount;
        saveData();
        updateTotalBalanceDisplay(); // Atualizar saldo total
        updateUI();
       
        showNotification('Transação atualizada!');
    }

    function deleteTransaction(id) {
        if (confirm('Tem certeza que deseja excluir esta transação?')) {
            const initialLength = transactions.length;
            transactions = transactions.filter(t => t.id !== id);
            
            if (transactions.length < initialLength) {
                saveData();
                updateTotalBalanceDisplay(); // Atualizar saldo total
                updateUI();
                showNotification('Transação excluída!');
            } else {
                showNotification('Transação não encontrada!', 'error');
            }
        }
    }

    // =========================================
    // DASHBOARD - FUNÇÃO MODIFICADA
    // =========================================
    function updateDashboard() {
        updateSummary();
        // updateTotalBalanceDisplay() NÃO é chamado aqui pois já é chamado separadamente
    }

    function updateSummary() {
        const monthTransactions = getMonthTransactions(currentYear, currentMonth);
       
        let totalIncome = 0;
        let totalExpense = 0;
       
        monthTransactions.forEach(transaction => {
            if (transaction.type === 'income') {
                totalIncome += transaction.amount;
            } else {
                totalExpense += transaction.amount;
            }
        });
       
        const balance = totalIncome - totalExpense;
       
        document.getElementById('total-income').textContent = formatCurrency(totalIncome);
        document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
        document.getElementById('total-balance').textContent = formatCurrency(balance);
    }

    function updateRecentTransactions() {
        const container = document.getElementById('recent-transactions');
        const typeFilter = document.getElementById('recent-filter-type').value;
        const categoryFilter = document.getElementById('recent-filter-category').value;
        const periodFilter = document.getElementById('recent-filter-period').value;
       
        let filtered = [...transactions];
       
        const now = new Date();
        if (periodFilter === 'current') {
            filtered = getMonthTransactions(currentYear, currentMonth);
        } else if (periodFilter === 'last30') {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            filtered = filtered.filter(t => new Date(t.date) >= thirtyDaysAgo);
        } else if (periodFilter === 'last7') {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            filtered = filtered.filter(t => new Date(t.date) >= sevenDaysAgo);
        }
       
        if (typeFilter) {
            filtered = filtered.filter(t => t.type === typeFilter);
        }
       
        if (categoryFilter) {
            filtered = filtered.filter(t => t.categoryId === parseInt(categoryFilter));
        }
       
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        filtered = filtered.slice(0, 20);
       
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <p>Nenhuma transação encontrada</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Adicione sua primeira transação usando o formulário</p>
                </div>
            `;
            return;
        }
       
        container.innerHTML = filtered.map(transaction => {
            const category = categories.find(c => c.id === transaction.categoryId);
            const date = new Date(transaction.date);
            const isToday = date.toDateString() === new Date().toDateString();
           
            // Verificar se a categoria tem imagem
            const iconStyle = category?.image 
                ? `background-image: url('${category.image}'); background-size: cover; background-position: center;`
                : `background: ${category?.color || '#3b82f6'};`;
           
            return `
                <div class="transaction-item ${transaction.type}">
                    <div class="transaction-icon" style="${iconStyle}">
                        ${!category?.image ? `<i class="${category?.icon || 'fas fa-question'}"></i>` : ''}
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-name">${transaction.description}</div>
                        <div class="transaction-meta">
                            <span>${formatDate(transaction.date)} ${isToday ? '<span class="badge badge-success">Hoje</span>' : ''}</span>
                            <span>${category?.name || 'Sem categoria'}</span>
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 10px;">
                        <button onclick="editTransaction(${transaction.id})" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction(${transaction.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // =========================================
    // TODAS AS TRANSAÇÕES COM CALENDÁRIO INFINITO
    // =========================================
    function updateAllTransactions() {
        const container = document.getElementById('all-transactions');
        const typeFilter = document.getElementById('all-filter-type').value;
        const categoryFilter = document.getElementById('all-filter-category').value;
        const yearFilter = document.getElementById('all-filter-year').value;
        const monthFilter = document.getElementById('all-filter-month').value;
       
        let filtered = [...transactions];
       
        // Filtrar por tipo
        if (typeFilter) {
            filtered = filtered.filter(t => t.type === typeFilter);
        }
       
        // Filtrar por categoria
        if (categoryFilter) {
            filtered = filtered.filter(t => t.categoryId === parseInt(categoryFilter));
        }
       
        // Filtrar por ano (CALENDÁRIO INFINITO)
        if (yearFilter) {
            const year = parseInt(yearFilter);
            if (!isNaN(year) && year >= 2000 && year <= 2100) {
                filtered = filtered.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() === year;
                });
            }
        }
       
        // Filtrar por mês
        if (monthFilter !== '') {
            filtered = filtered.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === parseInt(monthFilter);
                });
        }
       
        // Ordenar por data (mais recente primeiro)
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
       
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <p>Nenhuma transação encontrada</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Tente ajustar os filtros</p>
                </div>
            `;
            return;
        }
       
        container.innerHTML = filtered.map(transaction => {
            const category = categories.find(c => c.id === transaction.categoryId);
            const date = new Date(transaction.date);
            const isToday = date.toDateString() === new Date().toDateString();
           
            // Verificar se a categoria tem imagem
            const iconStyle = category?.image 
                ? `background-image: url('${category.image}'); background-size: cover; background-position: center;`
                : `background: ${category?.color || '#3b82f6'};`;
           
            return `
                <div class="transaction-item ${transaction.type}">
                    <div class="transaction-icon" style="${iconStyle}">
                        ${!category?.image ? `<i class="${category?.icon || 'fas fa-question'}"></i>` : ''}
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-name">${transaction.description}</div>
                        <div class="transaction-meta">
                            <span>${formatDate(transaction.date)} ${isToday ? '<span class="badge badge-success">Hoje</span>' : ''}</span>
                            <span>${category?.name || 'Sem categoria'}</span>
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 10px;">
                        <button onclick="editTransaction(${transaction.id})" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction(${transaction.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // =========================================
    // RELATÓRIOS MELHORADOS
    // =========================================
    function updateReports() {
        // Calcular totais
        let totalIncome = 0;
        let totalExpense = 0;
        
        transactions.forEach(transaction => {
            if (transaction.type === 'income') {
                totalIncome += transaction.amount;
            } else {
                totalExpense += transaction.amount;
            }
        });
        
        // Calcular taxa de economia
        let savingsRate = 0;
        if (totalIncome > 0) {
            savingsRate = ((totalIncome - totalExpense) / totalIncome) * 100;
        }
        
        // Atualizar valores nos cards
        document.getElementById('report-income').textContent = formatCurrency(totalIncome);
        document.getElementById('report-expense').textContent = formatCurrency(totalExpense);
        document.getElementById('report-savings').textContent = savingsRate.toFixed(1) + '%';
    }

    function generateReport() {
        const yearInput = document.getElementById('report-year').value;
        const monthSelect = document.getElementById('report-month').value;
        const typeSelect = document.getElementById('report-type').value;
        
        // Validar ano (CALENDÁRIO INFINITO)
        const year = parseInt(yearInput);
        if (!year || year < 2000 || year > 2100) {
            showNotification('Por favor, digite um ano válido (2000-2100)', 'error');
            return;
        }
        
        let filtered = transactions.filter(t => {
            const date = new Date(t.date);
            const yearMatch = date.getFullYear() === year;
            const monthMatch = monthSelect === '' || date.getMonth() === parseInt(monthSelect);
            const typeMatch = t.type === typeSelect;
            
            return yearMatch && monthMatch && typeMatch;
        });
        
        // Calcular totais por categoria
        const categoryTotals = {};
        filtered.forEach(transaction => {
            const category = categories.find(c => c.id === transaction.categoryId);
            const categoryName = category ? category.name : 'Sem categoria';
            
            if (!categoryTotals[categoryName]) {
                categoryTotals[categoryName] = 0;
            }
            categoryTotals[categoryName] += transaction.amount;
        });
        
        // Ordenar categorias por valor
        const sortedCategories = Object.entries(categoryTotals)
            .sort((a, b) => b[1] - a[1]);
        
        // Gerar HTML do relatório
        const reportContainer = document.getElementById('report-results');
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        
        const monthName = monthSelect === '' ? 'Todos os meses' : monthNames[parseInt(monthSelect)];
        const typeName = typeSelect === 'income' ? 'Ganhos' : 'Gastos';
        
        let html = `
            <h3 style="color: var(--primary); margin-bottom: 20px;">
                Relatório de ${typeName} - ${monthName} de ${year}
            </h3>
            <p style="color: var(--text-light); margin-bottom: 30px;">
                Total: <strong>${formatCurrency(filtered.reduce((sum, t) => sum + t.amount, 0))}</strong> | 
                Transações: <strong>${filtered.length}</strong>
            </p>
        `;
        
        if (sortedCategories.length === 0) {
            html += `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <p>Nenhuma transação encontrada</p>
                </div>
            `;
        } else {
            html += `
                <div style="background: var(--bg); border-radius: var(--radius); padding: 20px;">
                    <h4 style="color: var(--text); margin-bottom: 15px;">Distribuição por Categoria</h4>
            `;
            
            sortedCategories.forEach(([categoryName, total]) => {
                const percentage = (total / filtered.reduce((sum, t) => sum + t.amount, 0)) * 100;
                const category = categories.find(c => c.name === categoryName);
                const color = category ? category.color : '#3b82f6';
                
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 500;">${categoryName}</span>
                            <span style="font-weight: 600;">${formatCurrency(total)} (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${color}; width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        reportContainer.innerHTML = html;
        showNotification('Relatório gerado com sucesso!');
    }

    // =========================================
    // CATEGORIAS COM UPLOAD DE IMAGEM
    // =========================================
    function updateCategoriesList() {
        const container = document.getElementById('categories-list');
        
        if (categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <p>Nenhuma categoria cadastrada</p>
                </div>
            `;
            return;
        }
        
        // Separar categorias por tipo
        const incomeCategories = categories.filter(c => c.type === 'income');
        const expenseCategories = categories.filter(c => c.type === 'expense');
        
        let html = '';
        
        // Categorias de ganhos
        if (incomeCategories.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--success); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-arrow-up"></i> Ganhos
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            `;
            
            incomeCategories.forEach(category => {
                const iconStyle = category.image 
                    ? `background-image: url('${category.image}'); background-size: cover; background-position: center;`
                    : `background: ${category.color};`;
                
                html += `
                    <div class="category-item" style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; ${iconStyle}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            ${!category.image ? `<i class="${category.icon}"></i>` : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${category.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-light);">Ganho</div>
                            </div>
                            <button onclick="editCategory(${category.id})" style="background: none; border: none; color: var(--accent); cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCategory(${category.id})" style="background: none; border: none; color: var(--danger); cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // Categorias de gastos
        if (expenseCategories.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-arrow-down"></i> Gastos
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            `;
            
            expenseCategories.forEach(category => {
                const iconStyle = category.image 
                    ? `background-image: url('${category.image}'); background-size: cover; background-position: center;`
                    : `background: ${category.color};`;
                
                html += `
                    <div class="category-item" style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; ${iconStyle}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            ${!category.image ? `<i class="${category.icon}"></i>` : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${category.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Gasto</div>
                        </div>
                        <button onclick="editCategory(${category.id})" style="background: none; border: none; color: var(--accent); cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${category.id})" style="background: none; border: none; color: var(--danger); cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    function showCategoryForm() {
        document.getElementById('category-form-container').style.display = 'block';
        document.getElementById('category-form').reset();
        document.getElementById('category-color').value = '#3b82f6';
        document.getElementById('category-form-title').textContent = 'Adicionar Nova Categoria';
        document.getElementById('save-category-btn').innerHTML = '<i class="fas fa-save"></i> Salvar Categoria';
        document.getElementById('category-image-preview').style.display = 'none';
        document.getElementById('category-image-base64').value = '';
        editingCategoryId = null;
    }

    function hideCategoryForm() {
        document.getElementById('category-form-container').style.display = 'none';
        editingCategoryId = null;
    }

    function handleCategoryImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Verificar tamanho do arquivo (máximo 1MB)
        if (file.size > 1024 * 1024) {
            showNotification('A imagem deve ter no máximo 1MB', 'error');
            return;
        }
        
        // Verificar tipo do arquivo
        if (!file.type.match('image.*')) {
            showNotification('Por favor, selecione uma imagem válida', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('category-image-preview');
            const previewImg = document.getElementById('category-image-preview-img');
            const base64Input = document.getElementById('category-image-base64');
            
            previewImg.src = e.target.result;
            base64Input.value = e.target.result;
            imagePreview.style.display = 'block';
        };
        
        reader.readAsDataURL(file);
    }

    function removeCategoryImage() {
        document.getElementById('category-image-preview').style.display = 'none';
        document.getElementById('category-image-base64').value = '';
        document.getElementById('category-image-upload').value = '';
    }

    function saveCategory(e) {
        e.preventDefault();
        
        const name = document.getElementById('category-name').value.trim();
        const type = document.getElementById('category-type').value;
        const color = document.getElementById('category-color').value;
        const icon = document.getElementById('category-icon').value;
        const imageBase64 = document.getElementById('category-image-base64').value;
        
        if (!name) {
            showNotification('Por favor, digite um nome para a categoria!', 'error');
            return;
        }
        
        let categoryData = {
            name: name,
            type: type,
            color: color,
            icon: icon
        };
        
        // Adicionar imagem se existir
        if (imageBase64) {
            categoryData.image = imageBase64;
        }
        
        if (editingCategoryId) {
            // Atualizar categoria existente
            const index = categories.findIndex(c => c.id === editingCategoryId);
            if (index !== -1) {
                categories[index] = {
                    ...categories[index],
                    ...categoryData
                };
            }
            showNotification('Categoria atualizada com sucesso!');
        } else {
            // Adicionar nova categoria
            const newCategory = {
                id: Date.now(),
                ...categoryData
            };
            categories.push(newCategory);
            showNotification('Categoria salva com sucesso!');
        }
        
        saveCategories();
        updateCategoriesList();
        updateCategorySelects();
        hideCategoryForm();
    }

    function editCategory(id) {
        const category = categories.find(c => c.id === id);
        if (!category) return;
        
        showCategoryForm();
        editingCategoryId = id;
        
        document.getElementById('category-form-title').textContent = 'Editar Categoria';
        document.getElementById('save-category-btn').innerHTML = '<i class="fas fa-save"></i> Atualizar Categoria';
        document.getElementById('category-name').value = category.name;
        document.getElementById('category-type').value = category.type;
        document.getElementById('category-color').value = category.color;
        document.getElementById('category-icon').value = category.icon || 'fas fa-question';
        
        // Configurar imagem se existir
        if (category.image) {
            const imagePreview = document.getElementById('category-image-preview');
            const previewImg = document.getElementById('category-image-preview-img');
            const base64Input = document.getElementById('category-image-base64');
            
            previewImg.src = category.image;
            base64Input.value = category.image;
            imagePreview.style.display = 'block';
        }
    }

    function deleteCategory(id) {
        if (confirm('Tem certeza que deseja excluir esta categoria? As transações associadas não serão excluídas.')) {
            const initialLength = categories.length;
            categories = categories.filter(c => c.id !== id);
            
            if (categories.length < initialLength) {
                saveCategories();
                updateCategoriesList();
                updateCategorySelects();
                showNotification('Categoria excluída!');
            } else {
                showNotification('Categoria não encontrada!', 'error');
            }
        }
    }

    // =========================================
    // CONFIGURAÇÕES
    // =========================================
    function saveSettings() {
        const currency = document.getElementById('currency-select').value;
        const weekStart = document.getElementById('week-start').value;
        const notifTransaction = document.getElementById('notif-transaction').checked;
        const notifBalance = document.getElementById('notif-balance').checked;
        
        // Aqui você salvaria essas configurações no localStorage
        localStorage.setItem('minhas-financas-currency', currency);
        localStorage.setItem('minhas-financas-week-start', weekStart);
        localStorage.setItem('minhas-financas-notif-transaction', notifTransaction);
        localStorage.setItem('minhas-financas-notif-balance', notifBalance);
        
        showNotification('Configurações salvas com sucesso!');
    }

    // =========================================
    // HISTÓRICO DO ANO COM CALENDÁRIO INFINITO
    // =========================================
    function updateYearHistory(year = null) {
        const selectedYear = year || parseInt(document.getElementById('year-selector-input').value) || currentYear;
        const container = document.getElementById('year-history');
       
        document.getElementById('selected-year').textContent = selectedYear;
       
        let yearIncome = 0;
        let yearExpense = 0;
       
        const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
       
        let html = '';
       
        for (let month = 0; month < 12; month++) {
            const monthTransactions = getMonthTransactions(selectedYear, month);
           
            let income = 0;
            let expense = 0;
           
            monthTransactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    income += transaction.amount;
                    yearIncome += transaction.amount;
                } else {
                    expense += transaction.amount;
                    yearExpense += transaction.amount;
                }
            });
           
            const balance = income - expense;
            const isCurrent = selectedYear === currentYear && month === currentMonth;
           
            html += `
                <div class="year-card ${isCurrent ? 'current' : ''}" onclick="showMonthDetails(${selectedYear}, ${month})">
                    <div class="year-title">${monthNames[month]} ${selectedYear}</div>
                    <div class="year-stats">
                        <div class="year-stat">
                            <span class="year-label">Ganhos:</span>
                            <span class="year-value text-success">${formatCurrency(income)}</span>
                        </div>
                        <div class="year-stat">
                            <span class="year-label">Gastos:</span>
                            <span class="year-value text-danger">${formatCurrency(expense)}</span>
                        </div>
                        <div class="year-stat">
                            <span class="year-label">Saldo:</span>
                            <span class="year-value ${balance >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(balance)}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
       
        const yearBalance = yearIncome - yearExpense;
        document.getElementById('year-total-income').textContent = formatCurrency(yearIncome);
        document.getElementById('year-total-expense').textContent = formatCurrency(yearExpense);
        document.getElementById('year-total-balance').textContent = formatCurrency(yearBalance);
       
        container.innerHTML = html || `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-icon">
                    <i class="fas fa-history"></i>
                </div>
                <p>Nenhuma transação em ${selectedYear}</p>
            </div>
        `;
    }

    function showMonthDetails(year, month) {
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
       
        document.getElementById('month-details-title').textContent =
            `Detalhes de ${monthNames[month]} ${year}`;
       
        const monthTransactions = getMonthTransactions(year, month);
        const container = document.getElementById('month-transactions');
       
        monthTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
       
        if (monthTransactions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <p>Nenhuma transação em ${monthNames[month]} ${year}</p>
                </div>
            `;
        } else {
            container.innerHTML = monthTransactions.map(transaction => {
                const category = categories.find(c => c.id === transaction.categoryId);
                const date = new Date(transaction.date);
                const isToday = date.toDateString() === new Date().toDateString();
               
                // Verificar se a categoria tem imagem
                const iconStyle = category?.image 
                    ? `background-image: url('${category.image}'); background-size: cover; background-position: center;`
                    : `background: ${category?.color || '#3b82f6'};`;
               
                return `
                    <div class="transaction-item ${transaction.type}">
                        <div class="transaction-icon" style="${iconStyle}">
                            ${!category?.image ? `<i class="${category?.icon || 'fas fa-question'}"></i>` : ''}
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-name">${transaction.description}</div>
                            <div class="transaction-meta">
                                <span>${formatDate(transaction.date)} ${isToday ? '<span class="badge badge-success">Hoje</span>' : ''}</span>
                                <span>${category?.name || 'Sem categoria'}</span>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                            ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                        </div>
                        <div style="display: flex; gap: 10px; margin-left: 10px;">
                            <button onclick="editTransaction(${transaction.id})" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaction(${transaction.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
       
        document.getElementById('month-details').style.display = 'block';
        document.getElementById('month-details').scrollIntoView({ behavior: 'smooth' });
    }

    function closeMonthDetails() {
        document.getElementById('month-details').style.display = 'none';
    }

    // =========================================
    // CATEGORIAS E FILTROS
    // =========================================
    function updateCategorySelect(type) {
        const select = document.getElementById('category');
        select.innerHTML = '';
       
        const filteredCategories = categories.filter(c => c.type === type);
       
        if (filteredCategories.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Nenhuma categoria disponível';
            select.appendChild(option);
            return;
        }
       
        filteredCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
    }

    function updateCategorySelects() {
        // Atualizar filtro de categorias para transações recentes
        const recentFilterSelect = document.getElementById('recent-filter-category');
        recentFilterSelect.innerHTML = '<option value="">Todas categorias</option>';
       
        // Atualizar filtro de categorias para todas as transações
        const allFilterSelect = document.getElementById('all-filter-category');
        allFilterSelect.innerHTML = '<option value="">Todas categorias</option>';
       
        categories.forEach(category => {
            const option1 = document.createElement('option');
            option1.value = category.id;
            option1.textContent = `${category.type === 'income' ? '💰 ' : '💸 '}${category.name}`;
            recentFilterSelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = category.id;
            option2.textContent = `${category.type === 'income' ? '💰 ' : '💸 '}${category.name}`;
            allFilterSelect.appendChild(option2);
        });
       
        updateCategorySelect('income');
    }

    // =========================================
    // CONTROLES DE DATA COM CALENDÁRIO INFINITO
    // =========================================
    function changeYear(delta) {
        currentYear += delta;
        updateDateDisplay();
        updateDashboard();
        updateYearHistory(currentYear);
    }

    function changeMonth(delta) {
        currentMonth += delta;
       
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
       
        updateDateDisplay();
        updateDashboard();
    }

    function goToToday() {
        const now = new Date();
        currentYear = now.getFullYear();
        currentMonth = now.getMonth();
        updateDateDisplay();
        updateDashboard();
        updateYearHistory(currentYear);
        showNotification('Voltou para o mês atual');
    }

    function updateDateDisplay() {
        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
       
        document.getElementById('current-month-year').textContent =
            `${monthNames[currentMonth]} ${currentYear}`;
       
        document.getElementById('current-year').textContent = currentYear;
        document.getElementById('current-month').textContent = monthNames[currentMonth];
    }

    // =========================================
    // UTILITÁRIOS
    // =========================================
    function getMonthTransactions(year, month) {
        return transactions.filter(t => {
            const date = new Date(t.date);
            return date.getFullYear() === year && date.getMonth() === month;
        });
    }

    function formatDate(dateString) {
        try {
            return new Date(dateString).toLocaleDateString('pt-BR');
        } catch (e) {
            return dateString;
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 25px;
            background: ${type === 'error' ? 'var(--danger)' : type === 'warning' ? 'var(--warning)' : 'var(--success)'};
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 400px;
            font-weight: 500;
        `;
       
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}" style="font-size: 1.5rem;"></i>
            <span>${message}</span>
        `;
       
        document.body.appendChild(notification);
       
        setTimeout(() => {
            notification.style.animation = 'fadeIn 0.3s ease reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
</script>
